package com.stuartyee.taskmaestro.services;

import java.util.ArrayList;
import java.util.List;

import org.mindrot.jbcrypt.BCrypt;
import org.springframework.stereotype.Service;

import com.stuartyee.taskmaestro.models.Comment;
import com.stuartyee.taskmaestro.models.Task;
import com.stuartyee.taskmaestro.models.User;
import com.stuartyee.taskmaestro.repositories.CommentRepository;
import com.stuartyee.taskmaestro.repositories.TaskRepository;
import com.stuartyee.taskmaestro.repositories.UserRepository;

@Service
public class MainService {
	
	UserRepository uRepo;
	TaskRepository tRepo;
	CommentRepository cRepo;
	
	public MainService(UserRepository uRepo, TaskRepository tRepo, CommentRepository cRepo) {
		this.uRepo = uRepo;
		this.tRepo = tRepo;
		this.cRepo = cRepo;
	}
	
	
	//User methods
	public List<User> findAllUsers(){
		return uRepo.findAll();
	}
	
	public User findUserByUsername(String username) {
		try {
			return uRepo.findByUsername(username);
		} catch(Exception e){
			return null;
		}
	}
	
	public User findUserbyId(Long Id) {
		if(uRepo.findById(Id).isPresent()) {
			return uRepo.findById(Id).get();
		} else {
			return null;
		}
		
	}
	
	public boolean usernameExists(String username) {
		if(findUserByUsername(username) == null) {
			return false;
		} else {
			return true;
		}
	}
	
	public void saveUser(User user) {
		String hashpassword = BCrypt.hashpw(user.getPassword(), BCrypt.gensalt());
		user.setPassword(hashpassword);
		uRepo.save(user);
	}
	
	public boolean authenticateUser(String username, String password) {
		User user = uRepo.findByUsername(username);
		if(user == null) {
			return false;
		} else {
			if(BCrypt.checkpw(password, user.getPassword())) {
				return true;
			} else {
				return false;
			}
		}
	}
	
	public List<User> findNotHelping(Task task) {
		System.out.println("Made it to the service method to find nonHelpers");
		List<Long> userIds = new ArrayList<>();
		for(User user : task.getHelpers()) {
			userIds.add(user.getId());
		}
		if(task.getHelpers().isEmpty()) {
			return uRepo.findAll();
		} else {
			return uRepo.findByIdNotIn(userIds);
		}
	}
	
	
	//Task methods
	public void saveTask(Task task) {
		tRepo.save(task);
	}
	
	public List<Task> findAllTasks(){
		return tRepo.findAll();
	}
	
	public List<Task> findOpenTasksAsc(){
		return tRepo.findByCompletedFalseOrderByDueDateAsc();
	}
	
	public List<Task> findOpenTasksDsc(){
		return tRepo.findByCompletedFalseOrderByDueDateDesc();
	}
	
	public Task findTaskById(Long id) {
		return tRepo.findById(id).orElse(null);
	}
	
	// Comment Methods
	public void saveComment(String content, User user, Task task) {
		Comment comment = new Comment();
		comment.setContent(content);
		comment.setCommenter(user);
		comment.setParentTask(task);
		cRepo.save(comment);
	}
	
	public Comment findCommentById(Long id) {
		return cRepo.findById(id).orElse(null);
	}
	
	public void deleteComment(Comment comment, User user) {
		if(user.getId() == comment.getCommenter().getId()) {
			cRepo.delete(comment);
		}
	}
	
	public List<Comment> findCommentsByTask(Task task){
		return cRepo.findByParentTask(task);
	}
	
	
	
	

}
